spring:
  application:
    name: hddt-common-service

  main:
    web-application-type: reactive
    allow-bean-definition-overriding: true
    banner-mode: "off"

  cloud:
    compatibility-verifier:
      enabled: false

server:
  port: 8081


  jackson:
    serialization:
      write-dates-as-timestamps: false
    default-property-inclusion: non_null


# ===================== SECURITY =====================
security:
  jwt:
    enabled: true

    # >= 32 bytes (256 bits) – REQUIRED by RFC 7518
    secret: "THIS_IS_A_32_BYTE_SECRET_KEY_FOR_JWT_2026"

    issuer: common-service

    # seconds
    expiration-seconds: 3600          # 1 hour
    refresh-expiration-seconds: 86400 # 1 day

    header:
      authorization: Authorization
      prefix: Bearer

    claim:
      user-id: user_id
      username: username
      roles: role_codes


  # ===== Permission-based authorization =====
  permission:
    enabled: true
    role-prefix: ROLE_
    permission-prefix: PERM_


# ===================== GATEWAY =====================
gateway:
  security:
    enabled: true

    # headers propagated to downstream services
    headers:
      trace-id: X-Trace-Id
      user-id: X-User-Id
      username: X-Username
      roles: X-Roles

    # Optional: block routes at gateway level
    rules:
      enabled: false
      definitions:
        - path: /admin/**
          roles: [ADMIN]
        - path: /internal/**
          roles: [SYSTEM]


# ===================== LOGGING =====================
logging:
  level:
    root: INFO
    com.example.commonserviceofficial: DEBUG
    org.springframework.security: INFO
    org.springframework.cloud.gateway: INFO

  pattern:
    level: "%5p [${spring.application.name:},%X{traceId}]"

  file:
    name: logs/common-service.log


# ===================== COMMON LOGGING =====================
common:
  logging:
    enabled: true

    request:
      enabled: true
      include-headers: true
      include-body: false
      max-body-size: 2048

    response:
      enabled: true
      include-body: false

    trace:
      enabled: true
      header-name: X-Trace-Id


# ===================== MANAGEMENT =====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus

  endpoint:
    health:
      show-details: always


# ===================== ZOOKEEPER =====================
zookeeper:
  connection-string: ${ZOOKEEPER_CONNECTION_STRING:localhost:2181}
  session-timeout: ${ZOOKEEPER_SESSION_TIMEOUT:60000}
  connection-timeout: ${ZOOKEEPER_CONNECTION_TIMEOUT:15000}
  base-path: ${ZOOKEEPER_BASE_PATH:/sequences}
  retry-policy:
    base-sleep-time-ms: 1000
    max-retries: 3
    max-sleep-ms: 30000


# ===================== SEQUENCE GENERATOR =====================
sequence:
  zookeeper:
    base-path: ${ZOOKEEPER_BASE_PATH:/sequences}
    sync-interval: 10  # Sync với ZooKeeper mỗi 10 lần generate
    sync-threshold: 50 # Sync khi chênh lệch >= 50


# ===================== NOTIFICATION SERVICES =====================
notification:
  # Email Configuration
  email:
    enabled: ${EMAIL_ENABLED:true}
    async: ${EMAIL_ASYNC:true}
    retry:
      max-attempts: ${EMAIL_MAX_RETRY:3}
  
  # SMS Configuration  
  sms:
    enabled: ${SMS_ENABLED:true}
    provider: ${SMS_PROVIDER:mock}  # twilio, aws, viettel, mock
    async: ${SMS_ASYNC:true}
    retry:
      max-attempts: ${SMS_MAX_RETRY:3}
    
    # Twilio Settings
    twilio:
      account-sid: ${TWILIO_ACCOUNT_SID:}
      auth-token: ${TWILIO_AUTH_TOKEN:}
      from-number: ${TWILIO_FROM_NUMBER:}
    
    # AWS SNS Settings
    aws:
      access-key: ${AWS_ACCESS_KEY:}
      secret-key: ${AWS_SECRET_KEY:}
      region: ${AWS_REGION:us-east-1}
    
    # Viettel SMS Settings
    viettel:
      username: ${VIETTEL_SMS_USERNAME:}
      password: ${VIETTEL_SMS_PASSWORD:}
      cp-code: ${VIETTEL_CP_CODE:}
      service-id: ${VIETTEL_SERVICE_ID:}


# ===================== SPRING MAIL =====================
spring:
  mail:
    host: ${MAIL_HOST:smtp.gmail.com}
    port: ${MAIL_PORT:587}
    username: ${MAIL_USERNAME:}
    password: ${MAIL_PASSWORD:}
    from-name: ${MAIL_FROM_NAME:HDDT System}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
          connectiontimeout: 5000
          timeout: 3000
          writetimeout: 5000
